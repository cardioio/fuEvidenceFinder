# 免费内容判定算法技术文档

## 1. 算法概述

当前系统使用的免费内容判定算法是一个**多层次、优先级驱动的决策框架**，通过逐步检查不同维度的免费指标来确定文章是否提供免费全文访问。

## 2. 核心算法架构

### 2.1 主函数：`check_full_text_availability(pmid)`

```python
def check_full_text_availability(pmid):
    """
    免费全文可用性检查的核心算法
    输入：PMID字符串
    输出：判定结果字典
    """
```

### 2.2 算法执行流程

```
开始 → 网络请求获取PubMed页面 → 三层优先级检查 → 结果聚合 → 返回判定
```

## 3. 判定维度及优先级体系

### 3.1 优先级1：直接标识检查 (权重：100%)

**判定条件：**
- 查找HTML中`title="Free full text at PubMed Central"`的`<a>`元素
- 该元素存在且可点击

**阈值设定：**
- 必须精确匹配title属性值
- 元素必须为可交互的链接类型

**权重分配：**
- 权重值：100%
- 决策影响：直接确定结果，无需后续检查

**例外情况：**
- 无

### 3.2 优先级2：全文链接区域检查 (权重：80%)

**判定条件：**
- 扫描页面中包含"Full-text links"文本的区域
- 在该区域内查找所有`<a>`链接元素

**阈值设定：**
- 区域标识文本必须完全匹配（大小写敏感）
- 必须存在至少一个链接元素

**权重分配：**
- 权重值：80%
- 决策影响：高优先级，但需要进一步分析链接内容

**例外情况：**
- 如果区域存在但无有效链接，降权处理

### 3.3 优先级3：链接内容深度分析 (权重：60%)

当优先级1和2都未能确定时，系统进入深度分析阶段：

#### 3.3.1 PMC URL模式检查 (权重：25%)

**判定条件：**
- 检查链接URL是否包含"pmc.ncbi.nlm.nih.gov"
- 支持变体：NCBI PMC、PubMed Central等

**正则表达式：**
```python
pmc_patterns = [
    r'pmc\.ncbi\.nlm\.nih\.gov',
    r'www\.ncbi\.nlm\.nih\.gov/pmc',
    r'ncbi\.nlm\.nih\.gov/pmc'
]
```

**阈值设定：**
- URL必须包含完整PMC域名
- 支持子路径和查询参数

#### 3.3.2 EuropePMC URL检查 (权重：20%)

**判定条件：**
- 检查链接URL是否包含"europepmc.org"
- 支持多种EuropePMC链接格式

**正则表达式：**
```python
europepmc_patterns = [
    r'europepmc\.org',
    r'www\.europepmc\.org'
]
```

#### 3.3.3 免费关键词文本分析 (权重：15%)

**判定条件：**
- 分析链接的标题、文本内容和alt属性
- 查找免费相关的关键词

**关键词列表：**
```python
free_indicators = [
    'free', 'Free', 'FREE',
    'open access', 'Open Access', 'OPEN ACCESS',
    'full text', 'Full Text', 'FULL TEXT',
    '全文', '免费', '开放获取'
]
```

**阈值设定：**
- 关键词必须在文本中出现
- 支持部分匹配和大小写变体
- 至少匹配1个关键词即可触发

## 4. 权重计算与决策逻辑

### 4.1 权重累加机制

```python
def calculate_weighted_score(indicators):
    """
    权重计算示例：
    PMC URL匹配 → +25分
    EuropePMC URL匹配 → +20分  
    免费关键词匹配 → +15分
    总分 = Σ(匹配指标权重)
    """
    score = 0
    if indicators.get('has_pmc_url'):
        score += 25
    if indicators.get('has_europepmc_url'):
        score += 20
    if indicators.get('has_free_keywords'):
        score += 15
    return score
```

### 4.2 判定阈值

- **强免费指示 (总分≥40)：** 判定为免费
- **弱免费指示 (20≤总分<40)：** 需要人工确认
- **无免费指示 (总分<20)：** 判定为非免费

### 4.3 决策树逻辑

```
开始
├─ 检查直接标识 (Free full text at PubMed Central)
│   ├─ 找到 → 返回免费 (100%置信度)
│   └─ 未找到 → 继续
├─ 检查全文链接区域
│   ├─ 找到区域 → 进入深度分析
│   │   ├─ PMC URL → +25分
│   │   ├─ EuropePMC URL → +20分
│   │   └─ 免费关键词 → +15分
│   │   └─ 总分计算
│   │       ├─ ≥40分 → 免费
│   │       ├─ 20-39分 → 需确认
│   │       └─ <20分 → 非免费
│   └─ 未找到区域 → 判定为非免费
```

## 5. 模糊边界案例处理

### 5.1 边界情况定义

1. **部分免费链接：** 某些链接指向免费数据库但需要注册
2. **时效性免费：** 文章在特定时间窗口内免费
3. **地理限制：** 免费访问受地理位置限制
4. **混合内容：** 摘要免费但正文部分付费

### 5.2 处理策略

```python
def handle_boundary_cases(link_analysis):
    """
    模糊边界案例处理逻辑
    """
    # 案例1：检查是否需要注册
    if 'register' in link_analysis.get('url', '').lower():
        return {
            'is_free': False,
            'confidence': 'low',
            'reason': '需要用户注册'
        }
    
    # 案例2：检查地理限制标识
    if any(geo_term in link_analysis.get('text', '') 
           for geo_term in ['US only', 'regional', '地区限制']):
        return {
            'is_free': False,
            'confidence': 'low', 
            'reason': '存在地理访问限制'
        }
    
    # 案例3：混合内容检查
    if link_analysis.get('content_type') == 'abstract_only':
        return {
            'is_free': False,
            'confidence': 'medium',
            'reason': '仅提供摘要免费访问'
        }
```

## 6. 冲突解决策略

### 6.1 多重指标冲突

当不同维度的指标给出矛盾信号时：

1. **优先级覆盖原则：** 高优先级指标覆盖低优先级
2. **置信度加权：** 计算综合置信度分数
3. **保守决策原则：** 存在疑虑时倾向于保守判定

```python
def resolve_conflicts(indicators):
    """
    冲突解决算法
    """
    confidence_score = 0
    
    # 直接标识权重最高
    if indicators.get('direct_free标识'):
        return {'is_free': True, 'confidence': 'high'}
    
    # 累加其他指标分数
    for indicator, weight in INDICATOR_WEIGHTS.items():
        if indicators.get(indicator):
            confidence_score += weight
    
    # 决策阈值
    if confidence_score >= 60:
        return {'is_free': True, 'confidence': 'high'}
    elif confidence_score >= 30:
        return {'is_free': None, 'confidence': 'medium'}  # 需确认
    else:
        return {'is_free': False, 'confidence': 'low'}
```

## 7. 输出规则与数据格式

### 7.1 标准输出格式

```python
{
    "is_free": bool,           # 主要判定结果
    "confidence": str,         # 置信度等级: "high"/"medium"/"low"
    "source": str,            # 判定来源: "direct_identifier"/"link_analysis"/"none"
    "links": list,            # 发现的免费链接列表
    "indicators": dict,       # 各项指标详细结果
    "message": str,           # 人类可读的判定说明
    "debug_info": dict        # 调试信息
}
```

### 7.2 置信度等级定义

- **high：** 直接标识或强指标组合，置信度≥90%
- **medium：** 中等指标组合，置信度50-89%
- **low：** 弱指标或边界情况，置信度<50%

## 8. 算法限制与改进建议

### 8.1 当前限制

1. **网络依赖性：** 需要稳定的网络访问PubMed
2. **页面结构变化风险：** 依赖HTML结构选择器
3. **语言局限性：** 主要针对英文内容优化
4. **动态内容处理：** 对JavaScript渲染内容支持有限

### 8.2 改进建议

1. **增加缓存机制：** 缓存已验证的免费状态
2. **多数据源验证：** 整合多个数据库的免费信息
3. **机器学习增强：** 使用ML模型提升判定准确性
4. **用户反馈循环：** 收集用户纠错信息持续优化

## 9. 测试用例设计

### 9.1 基准测试集

```python
test_cases = {
    "直接标识型": {
        "pmid": "23430950",
        "expected": {"is_free": True, "confidence": "high"},
        "description": "包含Free full text at PubMed Central标识"
    },
    "PMC链接型": {
        "pmid": "示例PMID2", 
        "expected": {"is_free": True, "confidence": "high"},
        "description": "包含PMC免费链接"
    },
    "EuropePMC型": {
        "pmid": "示例PMID3",
        "expected": {"is_free": True, "confidence": "medium"},
        "description": "仅包含EuropePMC链接"
    },
    "非免费型": {
        "pmid": "示例PMID4",
        "expected": {"is_free": False, "confidence": "high"},
        "description": "无任何免费指标"
    }
}
```

## 10. 性能优化建议

1. **并行处理：** 同时检查多个判定维度
2. **早期终止：** 高优先级检查成功时立即返回
3. **缓存机制：** 避免重复检查相同文章
4. **超时控制：** 设置合理的网络请求超时时间

---

*本文档基于fuEvidenceFinder项目v1.0的pubmed.py模块分析生成*
*最后更新：2024年12月*