# PubMedè®¿é—®403é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## 1. 403 Forbiddené”™è¯¯å¸¸è§åŸå› 

### 1.1 ç½‘ç»œå±‚é¢é—®é¢˜
- **IPé™åˆ¶ï¼š** PubMedå¯¹é¢‘ç¹è®¿é—®çš„IPè¿›è¡Œä¸´æ—¶å°ç¦
- **åœ°ç†ä½ç½®é™åˆ¶ï¼š** æŸäº›åœ°åŒºå¯èƒ½æ— æ³•ç›´æ¥è®¿é—®PubMed
- **ç½‘ç»œä»£ç†é—®é¢˜ï¼š** ä¼ä¸šç½‘ç»œæˆ–ä»£ç†æœåŠ¡å™¨å¯èƒ½é˜»æ­¢è®¿é—®

### 1.2 è¯·æ±‚å¤´é—®é¢˜
- **User-Agentä¸å®Œæ•´ï¼š** å½“å‰å®ç°è™½ç„¶è®¾ç½®äº†User-Agentï¼Œä½†ç¼ºå°‘å…¶ä»–é‡è¦header
- **ç¼ºå°‘Refererï¼š** PubMedå¯èƒ½è¦æ±‚Referer headeréªŒè¯è¯·æ±‚æ¥æº
- **Accept-Languageè®¾ç½®ï¼š** è¯­è¨€è®¾ç½®å¯èƒ½å½±å“è®¿é—®æƒé™

### 1.3 è¯·æ±‚é¢‘ç‡é—®é¢˜
- **è¿‡äºé¢‘ç¹çš„è¯·æ±‚ï¼š** è¿ç»­å¿«é€Ÿè¯·æ±‚è§¦å‘åçˆ¬è™«æœºåˆ¶
- **å¹¶å‘è¯·æ±‚ï¼š** åŒæ—¶å‘èµ·å¤šä¸ªè¯·æ±‚å¯èƒ½è¢«è¯†åˆ«ä¸ºå¼‚å¸¸è¡Œä¸º

### 1.4 æœåŠ¡å™¨ç«¯é˜²æŠ¤
- **CSRFä¿æŠ¤ï¼š** æŸäº›é¡µé¢å¯èƒ½éœ€è¦CSRF token
- **ä¼šè¯éªŒè¯ï¼š** éœ€è¦ç»´æŠ¤æœ‰æ•ˆçš„ä¼šè¯çŠ¶æ€

## 2. å½“å‰å®ç°åˆ†æ

### 2.1 å½“å‰è¯·æ±‚å¤´é…ç½®
```python
headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Connection': 'keep-alive',
    'Upgrade-Insecure-Requests': '1',
}
```

### 2.2 å‘ç°çš„é—®é¢˜
1. **ç¼ºå°‘Referer header**
2. **Cookieå¤„ç†ä¸è¶³**
3. **è¯·æ±‚é—´éš”ä¸è¶³**
4. **æ²¡æœ‰é™çº§ç­–ç•¥**

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 å¢å¼ºè¯·æ±‚å¤´é…ç½®
```python
# å®Œæ•´çš„è¯·æ±‚å¤´é…ç½®
def get_enhanced_headers():
    return {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
        'Accept-Language': 'en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7',
        'Accept-Encoding': 'gzip, deflate, br',
        'Connection': 'keep-alive',
        'Upgrade-Insecure-Requests': '1',
        'Sec-Fetch-Dest': 'document',
        'Sec-Fetch-Mode': 'navigate',
        'Sec-Fetch-Site': 'none',
        'Sec-Fetch-User': '?1',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
        'Referer': 'https://pubmed.ncbi.nlm.nih.gov/',
        'sec-ch-ua': '"Not_A Brand";v="8", "Chromium";v="120", "Google Chrome";v="120"',
        'sec-ch-ua-mobile': '?0',
        'sec-ch-ua-platform': '"macOS"'
    }
```

### 3.2 è¯·æ±‚é¢‘ç‡æ§åˆ¶
```python
import time
import random

class RateLimiter:
    def __init__(self, min_delay=1.0, max_delay=3.0):
        self.min_delay = min_delay
        self.max_delay = max_delay
        self.last_request_time = 0
    
    def wait(self):
        current_time = time.time()
        time_since_last = current_time - self.last_request_time
        
        # éšæœºå»¶è¿Ÿ1-3ç§’
        delay = random.uniform(self.min_delay, self.max_delay)
        
        if time_since_last < delay:
            sleep_time = delay - time_since_last
            print(f"â³ ç­‰å¾… {sleep_time:.1f} ç§’åç»§ç»­...")
            time.sleep(sleep_time)
        
        self.last_request_time = time.time()
```

### 3.3 ä¼šè¯ç®¡ç†
```python
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

class PubMedSession:
    def __init__(self):
        self.session = requests.Session()
        
        # è®¾ç½®é‡è¯•ç­–ç•¥
        retry_strategy = Retry(
            total=3,
            backoff_factor=1,
            status_forcelist=[429, 500, 502, 503, 504],
        )
        
        adapter = HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("http://", adapter)
        self.session.mount("https://", adapter)
        
        # è®¾ç½®é»˜è®¤headers
        self.session.headers.update(get_enhanced_headers())
        
        # å…ˆè®¿é—®ä¸»é¡µå»ºç«‹ä¼šè¯
        self._initialize_session()
    
    def _initialize_session(self):
        try:
            print("ğŸ”„ åˆå§‹åŒ–PubMedä¼šè¯...")
            response = self.session.get('https://pubmed.ncbi.nlm.nih.gov/', 
                                      timeout=10, allow_redirects=True)
            print(f"âœ… ä¼šè¯åˆå§‹åŒ–æˆåŠŸï¼ŒçŠ¶æ€ç : {response.status_code}")
        except Exception as e:
            print(f"âš ï¸ ä¼šè¯åˆå§‹åŒ–å¤±è´¥: {e}")
    
    def get_with_retry(self, url, **kwargs):
        rate_limiter = RateLimiter()
        rate_limiter.wait()
        
        try:
            response = self.session.get(url, **kwargs)
            if response.status_code == 403:
                print(f"âŒ 403é”™è¯¯: {url}")
                print("ğŸ’¡ å¯èƒ½éœ€è¦: 1) æ›´æ¢IP 2) ç­‰å¾…ä¸€æ®µæ—¶é—´ 3) ä½¿ç”¨ä»£ç†")
                return None
            return response
        except Exception as e:
            print(f"âŒ è¯·æ±‚å¼‚å¸¸: {e}")
            return None
```

### 3.4 å¤‡ç”¨è®¿é—®æ–¹å¼

#### 3.4.1 ä½¿ç”¨EuropePMC API
```python
def check_fulltext_via_europepmc(pmid):
    """é€šè¿‡EuropePMC APIæ£€æŸ¥å…è´¹å…¨æ–‡"""
    try:
        # EuropePMC API endpoint
        api_url = f"https://www.ebi.ac.uk/europepmc/webservices/rest/search"
        params = {
            'query': f'EXT_ID:{pmid}',
            'resultType': 'core',
            'format': 'json'
        }
        
        response = requests.get(api_url, params=params, timeout=10)
        response.raise_for_status()
        
        data = response.json()
        
        if data.get('resultList', {}).get('result'):
            result = data['resultList']['result'][0]
            is_free = result.get('isOpenAccess', False)
            
            return {
                'is_free': is_free,
                'source': 'europepmc_api',
                'pmcid': result.get('pmcid'),
                'doi': result.get('doi')
            }
        
    except Exception as e:
        print(f"EuropePMC APIè®¿é—®å¤±è´¥: {e}")
        return {'is_free': False, 'source': 'europepmc_api', 'error': str(e)}
```

#### 3.4.2 ä½¿ç”¨PubMed Central API
```python
def check_fulltext_via_pmc_api(pmid):
    """é€šè¿‡PMC APIæ£€æŸ¥å…è´¹å…¨æ–‡"""
    try:
        # NCBI E-utilities API
        base_url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/"
        
        # å…ˆæŸ¥æ‰¾PMCID
        search_url = f"{base_url}esearch.fcgi"
        search_params = {
            'db': 'pubmed',
            'term': pmid,
            'retmode': 'json'
        }
        
        search_response = requests.get(search_url, params=search_params, timeout=10)
        search_data = search_response.json()
        
        if search_data.get('esearchresult', {}).get('id'):
            pmcid_search = search_data['esearchresult']['id'][0]
            
            # æ£€æŸ¥PMCçŠ¶æ€
            summary_url = f"{base_url}esummary.fcgi"
            summary_params = {
                'db': 'pubmed',
                'id': pmcid_search,
                'retmode': 'json'
            }
            
            summary_response = requests.get(summary_url, params=summary_params, timeout=10)
            summary_data = summary_response.json()
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å…è´¹å…¨æ–‡
            has_free = 'pubmedcentral' in str(summary_data).lower()
            
            return {
                'is_free': has_free,
                'source': 'ncbi_api',
                'pmcid': pmcid_search
            }
    
    except Exception as e:
        print(f"PMC APIè®¿é—®å¤±è´¥: {e}")
        return {'is_free': False, 'source': 'ncbi_api', 'error': str(e)}
```

## 4. å®æ–½å»ºè®®

### 4.1 ç«‹å³å¯è¡Œçš„è§£å†³æ–¹æ¡ˆ
1. **å¢å¼ºè¯·æ±‚å¤´é…ç½®** - æ·»åŠ Refererå’Œæ›´å®Œæ•´çš„header
2. **å®æ–½è¯·æ±‚é¢‘ç‡æ§åˆ¶** - æ·»åŠ éšæœºå»¶è¿Ÿ
3. **ä¼šè¯ç®¡ç†** - ä½¿ç”¨sessionç»´æŒè¿æ¥çŠ¶æ€
4. **é”™è¯¯å¤„ç†æ”¹è¿›** - æ›´å¥½çš„403é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 4.2 ä¸­æœŸæ”¹è¿›æ–¹æ¡ˆ
1. **å¤šæ•°æ®æºéªŒè¯** - ç»“åˆEuropePMCã€PMCç­‰å¤šä¸ªæ•°æ®æº
2. **æ™ºèƒ½é‡è¯•ç­–ç•¥** - åŸºäºé”™è¯¯ç±»å‹çš„æ™ºèƒ½é‡è¯•
3. **ç¼“å­˜æœºåˆ¶** - é¿å…é‡å¤è¯·æ±‚ç›¸åŒæ–‡ç« 
4. **ä»£ç†æ”¯æŒ** - æ”¯æŒä»£ç†æœåŠ¡å™¨è®¿é—®

### 4.3 é•¿æœŸè§£å†³æ–¹æ¡ˆ
1. **APIå¯†é’¥æ± ** - ä½¿ç”¨å¤šä¸ªAPIå¯†é’¥è½®æ¢
2. **åˆ†å¸ƒå¼è¯·æ±‚** - å¤šä¸ªIPåˆ†æ‹…è¯·æ±‚å‹åŠ›
3. **æœºå™¨å­¦ä¹ é¢„æµ‹** - é¢„æµ‹å“ªäº›æ–‡ç« å¯èƒ½æœ‰å…è´¹å…¨æ–‡
4. **ç”¨æˆ·åé¦ˆæœºåˆ¶** - æ”¶é›†ç”¨æˆ·éªŒè¯çš„å…è´¹çŠ¶æ€

## 5. æµ‹è¯•éªŒè¯

### 5.1 æµ‹è¯•ç”¨ä¾‹
```python
def test_improved_access():
    """æµ‹è¯•æ”¹è¿›åçš„è®¿é—®æ–¹æ³•"""
    test_pmids = [
        "23430950",  # é—®é¢˜PMID
        "12345678",  # å…¶ä»–æµ‹è¯•PMID
    ]
    
    for pmid in test_pmids:
        print(f"\nğŸ§ª æµ‹è¯•PMID: {pmid}")
        
        # æ–¹æ³•1: å¢å¼ºçš„ç½‘é¡µæŠ“å–
        result1 = check_fulltext_enhanced(pmid)
        print(f"å¢å¼ºæŠ“å–ç»“æœ: {result1}")
        
        # æ–¹æ³•2: EuropePMC API
        result2 = check_fulltext_via_europepmc(pmid)
        print(f"EuropePMCç»“æœ: {result2}")
        
        # æ–¹æ³•3: PMC API
        result3 = check_fulltext_via_pmc_api(pmid)
        print(f"PMC APIç»“æœ: {result3}")
```

### 5.2 æ€§èƒ½åŸºå‡†æµ‹è¯•
- æµ‹è¯•ä¸åŒæ–¹æ³•çš„æˆåŠŸç‡
- æµ‹é‡å“åº”æ—¶é—´
- åˆ†æé”™è¯¯ç±»å‹åˆ†å¸ƒ
- è¯„ä¼°èµ„æºæ¶ˆè€—

## 6. é£é™©è¯„ä¼°ä¸åˆè§„æ€§

### 6.1 ä½¿ç”¨è§„èŒƒ
- éµå®ˆPubMedä½¿ç”¨æ¡æ¬¾
- åˆç†æ§åˆ¶è¯·æ±‚é¢‘ç‡
- é¿å…å¤§è§„æ¨¡çˆ¬å–
- å°Šé‡ç‰ˆæƒå’ŒçŸ¥è¯†äº§æƒ

### 6.2 æŠ€æœ¯é£é™©
- IPå°ç¦é£é™©
- æ•°æ®è´¨é‡ä¸ç¨³å®š
- ä¾èµ–ç¬¬ä¸‰æ–¹æœåŠ¡
- æ³•å¾‹åˆè§„è€ƒè™‘

## 7. ç›‘æ§ä¸å‘Šè­¦

### 7.1 å…³é”®æŒ‡æ ‡ç›‘æ§
- 403é”™è¯¯ç‡
- å¹³å‡å“åº”æ—¶é—´
- æˆåŠŸç‡è¶‹åŠ¿
- é”™è¯¯ç±»å‹åˆ†å¸ƒ

### 7.2 å‘Šè­¦æœºåˆ¶
- 403é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘Šè­¦
- è¿ç»­å¤±è´¥æ—¶åˆ‡æ¢å¤‡ç”¨æ–¹æ¡ˆ
- ç½‘ç»œå¼‚å¸¸æ—¶é™çº§å¤„ç†

---

*æœ¬æŠ¥å‘ŠåŸºäºå¯¹fuEvidenceFinderé¡¹ç›®å½“å‰å®ç°çš„åˆ†æç”Ÿæˆ*
*å»ºè®®ä¼˜å…ˆå®æ–½å¢å¼ºè¯·æ±‚å¤´å’Œé¢‘ç‡æ§åˆ¶ä¸¤é¡¹æ”¹è¿›*