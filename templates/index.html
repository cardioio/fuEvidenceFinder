<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡çŒ®æ£€ç´¢ç³»ç»Ÿ</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è‡ªå®šä¹‰é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#4285f4',
                        'brand-red': '#ea4335',
                        'brand-yellow': '#fbbc05',
                        'brand-green': '#34a853'
                    }
                }
            }
        }
    </script>
    
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .log-console {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .log-entry {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-box {
            transition: all 0.3s ease;
        }
        
        .search-box:focus-within {
            box-shadow: 0 0 0 2px #4285f4;
        }
        
        .result-table {
            transition: all 0.3s ease;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* æ¨¡æ€çª—åŠ¨ç”» */
        .modal-enter {
            animation: modalEnter 0.3s ease-out forwards;
        }
        
        .modal-exit {
            animation: modalExit 0.3s ease-in forwards;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes modalExit {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
        }
        
        /* è¾“å…¥éªŒè¯æ ·å¼ */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
        }
        
        .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2) !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto px-4">
        <!-- é¡¶éƒ¨åŒºåŸŸ -->
        <div class="text-center py-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Full MED</h1>
            <p class="text-gray-600">Powered by LikeMED</p>
        </div>
        
        <!-- æœç´¢åŒºåŸŸ -->
        <div class="max-w-4xl mx-auto">
            
            <div id="search-section" class="mb-10">
                <div class="flex items-center bg-white rounded-full shadow-[0_2px_12px_rgba(0,0,0,0.08)] border border-gray-200 p-1.5 transition-all duration-300 focus-within:shadow-xl focus-within:border-brand-blue/50 focus-within:ring-4 focus-within:ring-brand-blue/10">
                    
                    <div class="pl-6 text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="è¾“å…¥å…³é”®è¯æœç´¢æ–‡çŒ® (ä¾‹å¦‚: Vitamin D COVID-19)"
                        class="flex-grow w-full bg-transparent px-4 py-3 outline-none text-lg text-gray-700 placeholder-gray-400"
                        autocomplete="off"
                    >

                    <button 
                        id="search-btn" 
                        class="flex-none bg-brand-blue hover:bg-blue-600 text-white font-medium text-lg py-3 px-8 rounded-full transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center min-w-[120px]"
                    >
                        <span id="search-btn-text">æœç´¢</span>
                        <div id="loading-spinner" class="hidden loading-spinner w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                    </button>
                </div>
            </div>
            
            <!-- äºŒæ¬¡ç¡®è®¤æ¨¡æ€çª— -->
            <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden transition-all duration-300">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                        <div class="p-6">
                            <!-- æ¨¡æ€çª—æ ‡é¢˜ -->
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-brand-blue mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ç¡®è®¤æœç´¢è®¾ç½®
                                </h3>
                                <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- æœç´¢å…³é”®è¯æ˜¾ç¤º -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">æœç´¢å…³é”®è¯</label>
                                <div id="modal-keyword-display" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-gray-800"></div>
                            </div>
                            
                            <!-- æœ€å¤§ç»“æœæ•°é‡è®¾ç½® -->
                            <div class="mb-6">
                                <label for="max-results" class="block text-sm font-medium text-gray-700 mb-2">
                                    æœ€å¤§è¿”å›ç»“æœæ•°é‡ <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <input 
                                        type="number" 
                                        id="max-results" 
                                        value="20" 
                                        min="1" 
                                        max="100" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent transition-all duration-200"
                                        placeholder="è¾“å…¥1-100ä¹‹é—´çš„æ•°å­—"
                                    >
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                        <span class="text-gray-500 text-sm">ç¯‡</span>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">å»ºè®®ï¼š10-50ç¯‡ä¸ºæœ€ä½³æœç´¢èŒƒå›´</p>
                            </div>
                            
                            <!-- åŸæ–‡æœç´¢é€‰é¡¹ -->
                            <div class="mb-6">
                                <div class="flex items-center">
                                    <input 
                                        type="checkbox" 
                                        id="enable-fulltext" 
                                        checked 
                                        class="h-4 w-4 text-brand-blue focus:ring-brand-blue border-gray-300 rounded transition-colors"
                                    >
                                    <label for="enable-fulltext" class="ml-2 block text-sm text-gray-700">
                                        å¼€å¯åŸæ–‡æœç´¢ (æ¨è)
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 ml-6 mt-1">å¯ç”¨åå°†è·å–å®Œæ•´çš„æ–‡çŒ®å†…å®¹å¹¶æä¾›æ›´è¯¦ç»†çš„åˆ†æ</p>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰é’® -->
                            <div class="flex space-x-3">
                                <button 
                                    id="cancel-btn" 
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    å–æ¶ˆ
                                </button>
                                <button 
                                    id="confirm-btn" 
                                    class="flex-1 bg-brand-blue hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-lg"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                    </svg>
                                    å¼€å§‹æœç´¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="execution-section" class="hidden">
                <!-- æœç´¢çŠ¶æ€æ  -->
                <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div id="status-indicator" class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                            <span id="status-text" class="text-gray-700 font-medium">å‡†å¤‡å°±ç»ª</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="result-count" class="text-sm text-gray-500">ç»“æœ: 0</span>
                            <button 
                                id="stop-btn" 
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                            >
                                ğŸ›‘ åœæ­¢æœç´¢
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- æ—¥å¿—æ§åˆ¶å° -->
                <div class="bg-black rounded-lg shadow-md mb-6">
                    <div class="bg-gray-800 px-4 py-2 rounded-t-lg">
                        <h3 class="text-green-400 font-mono text-sm">ğŸ“Š å®æ—¶æ—¥å¿—æ§åˆ¶å°</h3>
                    </div>
                    <div id="log-console" class="log-console h-48 overflow-y-auto p-4 text-green-400 text-sm space-y-1">
                        <div class="text-gray-500 text-center pt-8">ç­‰å¾…æœç´¢å¼€å§‹...</div>
                    </div>
                </div>
                
                <!-- ç»“æœè¡¨æ ¼ -->
               <div class="bg-white rounded-lg shadow-md border border-gray-200">
                    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 rounded-t-lg">
                        <h3 class="text-gray-800 font-semibold">ğŸ“‹ æœç´¢ç»“æœ</h3>
                    </div>
                    
                    <div class="result-table overflow-auto max-h-[75vh] relative scroll-smooth">
                        <table id="results-table" class="w-full border-collapse text-sm">
                            <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm text-gray-700">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">å‘è¡¨å¹´ä»½</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æ•°æ®æ”¶é›†å¹´ä»½</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">å›½å®¶</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">ç ”ç©¶ç±»å‹</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">ç ”ç©¶å¯¹è±¡</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æ ·æœ¬é‡</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æ¨èè¡¥å……å‰‚é‡</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">ä½œç”¨æœºç†</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">è¯æ®ç­‰çº§</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">ç»“è®ºæ‘˜è¦</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æ ‡é¢˜</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">PMID</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">å…¨æ–‡çŠ¶æ€</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">å…¨æ–‡é“¾æ¥æ•°</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æå–çŠ¶æ€</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">æ‘˜è¦å†…å®¹</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">å…¨æ–‡æ‘˜è¦</th>
                                    <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider whitespace-nowrap bg-gray-100">è¯¦æƒ…</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="18" class="px-6 py-8 text-center text-gray-500">
                                        æš‚æ— æœç´¢ç»“æœ
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

    <script>
        // å…¨å±€å˜é‡
        let isSearching = false;
        let currentController = null; // ç”¨äºå–æ¶ˆ fetch è¯·æ±‚
        let currentKeyword = ''; // å½“å‰æœç´¢å…³é”®è¯
        
        // DOM å…ƒç´ 
        const searchBtn = document.getElementById('search-btn');
        const searchBtnText = document.getElementById('search-btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const searchInput = document.getElementById('search-input');
        const searchSection = document.getElementById('search-section');
        const executionSection = document.getElementById('execution-section');
        const logConsole = document.getElementById('log-console');
        const resultsTbody = document.getElementById('results-tbody');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const resultCount = document.getElementById('result-count');
        const stopBtn = document.getElementById('stop-btn');
        
        // æ¨¡æ€çª—ç›¸å…³DOMå…ƒç´ 
        const confirmModal = document.getElementById('confirm-modal');
        const modalContent = document.getElementById('modal-content');
        const modalKeywordDisplay = document.getElementById('modal-keyword-display');
        const maxResultsInput = document.getElementById('max-results');
        const enableFulltextCheckbox = document.getElementById('enable-fulltext');
        const confirmBtn = document.getElementById('confirm-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const closeModalBtn = document.getElementById('close-modal');
        
        // äº‹ä»¶ç›‘å¬å™¨
        searchBtn.addEventListener('click', startSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startSearch();
            }
        });
        stopBtn.addEventListener('click', stopSearch);
        
        // æ¨¡æ€çª—äº‹ä»¶ç›‘å¬å™¨
        confirmBtn.addEventListener('click', confirmSearch);
        cancelBtn.addEventListener('click', closeModal);
        closeModalBtn.addEventListener('click', closeModal);
        maxResultsInput.addEventListener('input', validateMaxResults);
        maxResultsInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                confirmSearch();
            }
        });
        enableFulltextCheckbox.addEventListener('change', function() {
            if (this.checked) {
                addLog('å·²å¼€å¯åŸæ–‡æœç´¢æ¨¡å¼', 'info');
            } else {
                addLog('å·²å…³é—­åŸæ–‡æœç´¢æ¨¡å¼', 'warning');
            }
        });
        
        // å¼€å§‹æœç´¢
        function startSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            if (isSearching) {
                alert('æœç´¢æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…å®Œæˆåå†è¯•');
                return;
            }
            
            // æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤æ¨¡æ€çª—
            showConfirmModal(keyword);
        }
        
        // æ˜¾ç¤ºäºŒæ¬¡ç¡®è®¤æ¨¡æ€çª—
        function showConfirmModal(keyword) {
            currentKeyword = keyword;
            modalKeywordDisplay.textContent = keyword;
            validateMaxResults(); // åˆå§‹éªŒè¯
            confirmModal.classList.remove('hidden');
            
            // åŠ¨ç”»æ˜¾ç¤ºæ¨¡æ€çª—
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // èšç„¦åˆ°ç»“æœæ•°é‡è¾“å…¥æ¡†
            setTimeout(() => {
                maxResultsInput.focus();
                maxResultsInput.select();
            }, 300);
            
            addLog(`å‡†å¤‡æœç´¢å…³é”®è¯: "${keyword}"`, 'info');
        }
        
        // å…³é—­æ¨¡æ€çª—
        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                confirmModal.classList.add('hidden');
                currentKeyword = '';
            }, 300);
        }
        
        // éªŒè¯æœ€å¤§ç»“æœæ•°é‡è¾“å…¥
        function validateMaxResults() {
            const value = parseInt(maxResultsInput.value);
            const min = parseInt(maxResultsInput.min);
            const max = parseInt(maxResultsInput.max);
            
            // ç§»é™¤ä¹‹å‰çš„éªŒè¯æ ·å¼
            maxResultsInput.classList.remove('input-error', 'input-success');
            
            if (isNaN(value) || value < min || value > max) {
                maxResultsInput.classList.add('input-error');
                confirmBtn.disabled = true;
                return false;
            } else {
                maxResultsInput.classList.add('input-success');
                confirmBtn.disabled = false;
                return true;
            }
        }
        
        // æ·»åŠ è¾“å…¥éªŒè¯æç¤º
        function addInputValidationTips() {
            // å®æ—¶æç¤ºå»ºè®®æ•°é‡
            maxResultsInput.addEventListener('input', function() {
                const value = parseInt(this.value);
                let tipText = '';
                let tipClass = 'text-gray-500';
                
                if (isNaN(value)) {
                    tipText = 'è¯·è¾“å…¥æœ‰æ•ˆæ•°å­—';
                    tipClass = 'text-red-500';
                } else if (value < 10) {
                    tipText = 'âš ï¸ ç»“æœè¾ƒå°‘ï¼Œå¯èƒ½å½±å“åˆ†æçš„å…¨é¢æ€§';
                    tipClass = 'text-yellow-600';
                } else if (value > 50) {
                    tipText = 'âš ï¸ ç»“æœè¾ƒå¤šï¼Œæœç´¢æ—¶é—´å¯èƒ½è¾ƒé•¿';
                    tipClass = 'text-yellow-600';
                } else {
                    tipText = 'âœ… æ¨èèŒƒå›´ï¼Œåˆ†ææ•ˆæœæœ€ä½³';
                    tipClass = 'text-green-600';
                }
                
                // æ›´æ–°æç¤ºæ–‡æœ¬ï¼ˆå¦‚æœå­˜åœ¨æç¤ºå…ƒç´ ï¼‰
                let tipElement = document.getElementById('results-tip');
                if (!tipElement) {
                    tipElement = document.createElement('p');
                    tipElement.id = 'results-tip';
                    tipElement.className = 'text-xs mt-1 transition-colors duration-200';
                    maxResultsInput.parentNode.parentNode.appendChild(tipElement);
                }
                tipElement.textContent = tipText;
                tipElement.className = `text-xs mt-1 transition-colors duration-200 ${tipClass}`;
            });
        }
        
        // å¢å¼ºçŠ¶æ€åé¦ˆ
        function enhanceStatusFeedback() {
            // æœç´¢æŒ‰é’®çŠ¶æ€åé¦ˆ
            function updateSearchButtonState(searching, disabled = false) {
                if (disabled) {
                    searchBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    searchBtn.disabled = true;
                    return;
                }
                
                if (searching) {
                    searchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    searchBtn.disabled = true;
                    searchBtnText.textContent = 'æœç´¢ä¸­...';
                    loadingSpinner.classList.remove('hidden');
                } else {
                    searchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    searchBtn.disabled = false;
                    searchBtnText.textContent = 'æœç´¢';
                    loadingSpinner.classList.add('hidden');
                }
            }
            
            // ç¡®è®¤æŒ‰é’®çŠ¶æ€åé¦ˆ
            function updateConfirmButtonState(valid, processing = false) {
                if (processing) {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = `
                        <div class="loading-spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></div>
                        å¤„ç†ä¸­...
                    `;
                } else {
                    confirmBtn.disabled = !valid;
                    confirmBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        å¼€å§‹æœç´¢
                    `;
                }
            }
            
            return { updateSearchButtonState, updateConfirmButtonState };
        }
        
        // ç¡®è®¤æœç´¢
        function confirmSearch() {
            if (!validateMaxResults()) {
                addLog('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»“æœæ•°é‡ (1-100)', 'error');
                return;
            }
            
            const maxResults = parseInt(maxResultsInput.value);
            const enableFulltext = enableFulltextCheckbox.checked;
            
            // æ˜¾ç¤ºç¡®è®¤æŒ‰é’®å¤„ç†çŠ¶æ€
            const { updateConfirmButtonState } = enhanceStatusFeedback();
            updateConfirmButtonState(true, true);
            
            // å…³é—­æ¨¡æ€çª—
            closeModal();
            
            // å¼€å§‹æ‰§è¡Œæœç´¢
            executeSearch(currentKeyword, maxResults, enableFulltext);
        }
        
        // æ‰§è¡Œæœç´¢
        function executeSearch(keyword, maxResults, enableFulltext) {
            if (isSearching) return;
            
            // æ˜¾ç¤ºæ‰§è¡ŒåŒºåŸŸ
            executionSection.classList.remove('hidden');
            searchSection.classList.add('hidden');
            
            // é‡ç½®ç•Œé¢
            clearLogs();
            clearResults();
            updateStatus('æ­£åœ¨åˆå§‹åŒ–...', 'loading');
            
            // è®°å½•æœç´¢é…ç½®
            addLog(`æœç´¢é…ç½® - å…³é”®è¯: "${keyword}"`, 'info');
            addLog(`æœç´¢é…ç½® - æœ€å¤§ç»“æœæ•°: ${maxResults}ç¯‡`, 'info');
            addLog(`æœç´¢é…ç½® - åŸæ–‡æœç´¢: ${enableFulltext ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
            
            // å¼€å§‹æœç´¢
            isSearching = true;
            updateSearchButton(true);
            startStreamSearch(keyword, maxResults, enableFulltext);
        }
        
        // åœæ­¢æœç´¢
        function stopSearch() {
            if (!isSearching) return;
            
            isSearching = false;
            updateSearchButton(false);
            updateStatus('æœç´¢å·²åœæ­¢', 'stopped');
            
            // å–æ¶ˆ fetch è¯·æ±‚
            if (currentController) {
                currentController.abort();
                currentController = null;
            }
            
            addLog('ç”¨æˆ·åœæ­¢äº†æœç´¢', 'warning');
        }
        
        // å¼€å§‹æµå¼æœç´¢
        function startStreamSearch(keyword, maxResults = 20, enableFulltext = true) {
            const url = `http://localhost:5001/stream_search?keyword=${encodeURIComponent(keyword)}&max_results=${maxResults}&enable_fulltext=${enableFulltext}`;
            
            // åˆ›å»º AbortController ç”¨äºå–æ¶ˆè¯·æ±‚
            currentController = new AbortController();
            
            // ä½¿ç”¨ fetch API æ¥æ”¶æµæ•°æ®
            fetch(url, { signal: currentController.signal })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    // çŠ¶æ€è®¡æ•°å™¨
                    let processedResults = 0;
                    
                    function processData() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                console.log('æµæ•°æ®è¯»å–å®Œæˆ');
                                isSearching = false;
                                updateSearchButton(false);
                                updateStatus('æœç´¢å®Œæˆ', 'completed');
                                addLog(`æœç´¢å®Œæˆï¼Œå…±è·å– ${processedResults} æ¡ç»“æœ`, 'success');
                                return;
                            }
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // ä¿å­˜ä¸å®Œæ•´çš„è¡Œ
                            
                            lines.forEach(line => {
                                line = line.trim();
                                if (line.startsWith('data: ')) {
                                    try {
                                        const jsonStr = line.substring(6); // ç§»é™¤ 'data: ' å‰ç¼€
                                        const data = JSON.parse(jsonStr);
                                        
                                        if (!isSearching) return;
                                        
                                        if (data.type === 'log' && data.content) {
                                            // å¤„ç†æ—¥å¿—æ¶ˆæ¯
                                            const { timestamp, level, message } = data.content;
                                            addLog(message, level);
                                            
                                            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                                            if (message.includes('å¼€å§‹æœç´¢')) {
                                                updateStatus('æ­£åœ¨æœç´¢ä¸­...', 'running');
                                            } else if (message.includes('å®Œæˆ')) {
                                                updateStatus('æœç´¢å®Œæˆ', 'completed');
                                            }
                                            
                                        } else if (data.type === 'row' && data.content) {
                                            // å¤„ç†æ•°æ®è¡Œ
                                            addResultRow(data.content);
                                            processedResults++;
                                            resultCount.textContent = `ç»“æœ: ${processedResults}`;
                                            
                                        } else if (data.type === 'end') {
                                            isSearching = false;
                                            updateSearchButton(false);
                                            updateStatus('æœç´¢å®Œæˆ', 'completed');
                                            addLog(`æœç´¢å®Œæˆï¼Œå…±è·å– ${processedResults} æ¡ç»“æœ`, 'success');
                                        } else if (data.type === 'stopped') {
                                            isSearching = false;
                                            updateSearchButton(false);
                                            updateStatus('æœç´¢å·²åœæ­¢', 'stopped');
                                            addLog(`æœç´¢å·²åœæ­¢ï¼Œå·²è·å– ${processedResults} æ¡ç»“æœ`, 'warning');
                                        }
                                    } catch (parseError) {
                                        console.error('è§£ææ•°æ®å‡ºé”™:', parseError, 'åŸå§‹æ•°æ®:', line);
                                    }
                                }
                            });
                            
                            if (isSearching) {
                                processData();
                            }
                        });
                    }
                    
                    processData();
                })
                .catch(error => {
                    console.error('æµå¼æœç´¢é”™è¯¯:', error);
                    isSearching = false;
                    updateSearchButton(false);
                    updateStatus('æœç´¢å¤±è´¥: ' + error.message, 'error');
                    addLog('æœç´¢è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        // æ›´æ–°æœç´¢æŒ‰é’®çŠ¶æ€
        function updateSearchButton(searching) {
            if (searching) {
                searchBtn.disabled = true;
                searchBtnText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                searchBtn.disabled = false;
                searchBtnText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, type) {
            statusText.textContent = text;
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            statusIndicator.className = 'w-3 h-3 rounded-full';
            switch (type) {
                case 'loading':
                case 'running':
                    statusIndicator.classList.add('bg-yellow-500', 'animate-pulse');
                    break;
                case 'completed':
                    statusIndicator.classList.add('bg-green-500');
                    break;
                case 'stopped':
                case 'error':
                    statusIndicator.classList.add('bg-red-500');
                    break;
                default:
                    statusIndicator.classList.add('bg-green-500');
            }
        }
        
        // æ·»åŠ æ—¥å¿—
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry flex items-start space-x-3 text-sm';
            
            // æ ¹æ®æ—¥å¿—çº§åˆ«è®¾ç½®é¢œè‰²
            let colorClass = 'text-green-400';
            if (level === 'warning') colorClass = 'text-yellow-400';
            if (level === 'error' || level === 'danger') colorClass = 'text-red-400';
            if (level === 'success') colorClass = 'text-green-300';
            
            logEntry.innerHTML = `
                <span class="text-gray-500 text-xs mt-0.5">${timestamp}</span>
                <span class="${colorClass}">${message}</span>
            `;
            
            logConsole.appendChild(logEntry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logConsole.innerHTML = '<div class="text-gray-500 text-center pt-8">ç­‰å¾…æœç´¢å¼€å§‹...</div>';
        }
        
        // æ¸…ç©ºç»“æœ
        function clearResults() {
            resultsTbody.innerHTML = `
                <tr>
                    <td colspan="18" class="px-6 py-8 text-center text-gray-500">
                        æš‚æ— æœç´¢ç»“æœ
                    </td>
                </tr>
            `;
        }
        
        // æ·»åŠ å•è¡Œç»“æœ
        function addResultRow(result) {
            // å¦‚æœæ˜¯ç¬¬ä¸€è¡Œç»“æœï¼Œæ¸…ç©º"æš‚æ— æœç´¢ç»“æœ"æç¤º
            const emptyRow = resultsTbody.querySelector('tr td[colspan="18"]');
            if (emptyRow) {
                resultsTbody.innerHTML = '';
            }
            
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors opacity-0';
            
            // å¤„ç†å¯èƒ½ä¸ºç©ºçš„å­—æ®µ
            const publishedYear = result.å‘è¡¨å¹´ä»½ || '-';
            const dataCollectionYear = result.æ•°æ®æ”¶é›†å¹´ä»½ || '-';
            const country = result.å›½å®¶ || '-';
            const studyType = result.ç ”ç©¶ç±»å‹ || '-';
            const studySubject = result.ç ”ç©¶å¯¹è±¡ || '-';
            const sampleSize = result.æ ·æœ¬é‡ || '-';
            const recommendedDose = result['æ¨èè¡¥å……å‰‚é‡/ç”¨æ³•'] || '-';
            const mechanism = result.ä½œç”¨æœºç† || '-';
            const evidenceLevel = result.è¯æ®ç­‰çº§ || '-';
            const conclusion = result.ç»“è®ºæ‘˜è¦ || '-';
            const title = result.æ ‡é¢˜ || '-';
            const pmid = result.PMID || '-';
            const fulltextStatus = result.å…è´¹å…¨æ–‡çŠ¶æ€ || '-';
            const fulltextLinks = result.å…è´¹å…¨æ–‡é“¾æ¥æ•° || '-';
            const extractionStatus = result.å…¨æ–‡æå–çŠ¶æ€ || '-';
            const abstractContent = result.æ‘˜è¦ä¸»è¦å†…å®¹ || '-';
            const fulltextSummary = result.å…¨æ–‡å†…å®¹æ‘˜è¦ || '-';
            
            // æˆªæ–­é•¿æ–‡æœ¬ä»¥ä¿æŒè¡¨æ ¼ç¾è§‚
            const truncateText = (text, maxLength = 50) => {
                if (!text || text === '-') return '-';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            };
            
            // æ ¼å¼åŒ–å…¨æ–‡çŠ¶æ€æ˜¾ç¤º
            const getStatusBadge = (status) => {
                if (!status || status === '-') return '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">-</span>';
                if (status === 'å¯ç”¨') return '<span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">å¯ç”¨</span>';
                if (status === 'å·²æå–') return '<span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">å·²æå–</span>';
                if (status === 'æå–ä¸­') return '<span class="px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">æå–ä¸­</span>';
                return `<span class="px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">${status}</span>`;
            };
            
            row.innerHTML = `
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${publishedYear}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${dataCollectionYear}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${country}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${studyType}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${studySubject}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${sampleSize}</td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-24">
                    <div class="truncate" title="${recommendedDose}">${truncateText(recommendedDose, 25)}</div>
                </td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-24">
                    <div class="truncate" title="${mechanism}">${truncateText(mechanism, 25)}</div>
                </td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${evidenceLevel}</td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-32">
                    <div class="truncate" title="${conclusion}">${truncateText(conclusion, 30)}</div>
                </td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-40">
                    <div class="truncate" title="${title}">${truncateText(title, 35)}</div>
                </td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${pmid}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">
                    ${getStatusBadge(fulltextStatus)}
                </td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">${fulltextLinks}</td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">
                    ${getStatusBadge(extractionStatus)}
                </td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-24">
                    <div class="truncate" title="${abstractContent}">${truncateText(abstractContent, 20)}</div>
                </td>
                <td class="px-2 py-4 text-xs text-gray-900 max-w-24">
                    <div class="truncate" title="${fulltextSummary}">${truncateText(fulltextSummary, 20)}</div>
                </td>
                <td class="px-2 py-4 whitespace-nowrap text-xs text-gray-900">
                    <button class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 border border-blue-200 rounded hover:bg-blue-50 transition-colors" onclick="showResultDetails('${result.PMID || ''}')">
                        æŸ¥çœ‹è¯¦æƒ…
                    </button>
                </td>
            `;
            
            resultsTbody.appendChild(row);
            
            // åŠ¨ç”»æ˜¾ç¤ºæ–°è¡Œ
            setTimeout(() => {
                row.style.transition = 'opacity 0.3s ease';
                row.classList.remove('opacity-0');
            }, 10);
        }
        
        // æ˜¾ç¤ºç»“æœè¯¦æƒ…ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
        function showResultDetails(result) {
            const details = `
æ ‡é¢˜: ${result.æ ‡é¢˜ || '-'}
PMID: ${result.PMID || '-'}
å‘è¡¨å¹´ä»½: ${result.å‘è¡¨å¹´ä»½ || '-'}
å›½å®¶: ${result.å›½å®¶ || '-'}
ç ”ç©¶ç±»å‹: ${result.ç ”ç©¶ç±»å‹ || '-'}
ç ”ç©¶å¯¹è±¡: ${result.ç ”ç©¶å¯¹è±¡ || '-'}
æ ·æœ¬é‡: ${result.æ ·æœ¬é‡ || '-'}
ä½œç”¨æœºç†: ${result.ä½œç”¨æœºç† || '-'}
æ¨èå‰‚é‡: ${result['æ¨èè¡¥å……å‰‚é‡/ç”¨æ³•'] || '-'}
æ•°æ®æ”¶é›†å¹´ä»½: ${result.æ•°æ®æ”¶é›†å¹´ä»½ || '-'}
è¯æ®ç­‰çº§: ${result.è¯æ®ç­‰çº§ || '-'}
ç»“è®ºæ‘˜è¦: ${result.ç»“è®ºæ‘˜è¦ || '-'}
æ‘˜è¦ä¸»è¦å†…å®¹: ${result.æ‘˜è¦ä¸»è¦å†…å®¹ || '-'}
å…è´¹å…¨æ–‡çŠ¶æ€: ${result.å…è´¹å…¨æ–‡çŠ¶æ€ || '-'}
            `;
            
            alert(details);
        }
        
        // æ˜¾ç¤ºç»“æœï¼ˆå…¼å®¹æ€§å‡½æ•°ï¼‰
        function displayResults(results) {
            if (!results || results.length === 0) {
                clearResults();
                return;
            }
            
            clearResults();
            results.forEach(result => {
                addResultRow(result);
            });
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“š æ–‡çŒ®æ£€ç´¢ç³»ç»Ÿå·²åŠ è½½');
            
            // åˆå§‹åŒ–è¾“å…¥éªŒè¯æç¤º
            addInputValidationTips();
            
            // ç„¦ç‚¹åˆ°æœç´¢æ¡†
            searchInput.focus();
        });
    </script>
</body>
</html>